<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Master - Play & Earn</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #0088cc, #2ea6ff);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            background: white;
        }
        .header {
            background: linear-gradient(135deg, #0088cc, #2ea6ff);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        .content {
            padding: 20px;
        }
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background: #0088cc;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }
        .loading {
            text-align: center;
            padding: 50px 20px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }
        }
        .balance-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #00b894;
            text-align: center;
            margin: 20px 0;
        }
        .feature-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .feature-icon {
            font-size: 1.5em;
            margin-right: 15px;
            color: #0088cc;
        }
        .chess-board {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border: 3px solid #333;
            border-radius: 5px;
            overflow: hidden;
        }
        .board-row { display: flex; }
        .square {
            width: 12.5%;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .square.light { background-color: #f0d9b5; }
        .square.dark { background-color: #b58863; }
        .piece { font-size: 2em; cursor: pointer; }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading -->
        <div id="loading-screen" class="screen active">
            <div class="loading">
                <div class="spinner"></div>
                <h4>Loading Chess Master...</h4>
            </div>
        </div>
        
        <!-- Register -->
        <div id="welcome-screen" class="screen">
            <div class="header">
                <h1>‚ôüÔ∏è Chess Master</h1>
                <p>Play Chess & Earn Money!</p>
            </div>
            <div class="content">
                <div style="text-align: center; font-size: 4em; margin: 20px 0;">üéÆ</div>
                <div class="card">
                    <div class="card-body">
                        <h4>Create Your Account</h4>
                        <p>Get <strong>10 birr FREE</strong> now!</p>
                        
                        <div class="feature-item">
                            <div class="feature-icon">üí∞</div>
                            <div>
                                <strong>10 birr Welcome Bonus</strong>
                                <p class="mb-0">Free money to start</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">üèÜ</div>
                            <div>
                                <strong>Earn 10 birr per win</strong>
                                <p class="mb-0">Play chess and earn</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">üéÆ</div>
                            <div>
                                <strong>Real-time Chess</strong>
                                <p class="mb-0">Play with friends</p>
                            </div>
                        </div>
                        
                        <button id="btn-register" class="btn btn-primary w-100 mt-4" onclick="registerUser()">
                            üéÆ Register & Get 10 birr
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard -->
        <div id="dashboard-screen" class="screen">
            <div class="header">
                <h1 id="greeting">Welcome!</h1>
                <p>Your Chess Dashboard</p>
            </div>
            <div class="content">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">YOUR BALANCE</h6>
                        <div class="balance-display" id="balance">0 birr</div>
                        <div class="badge bg-success">+10 birr per win</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5>Quick Play</h5>
                        <button class="btn btn-primary w-100 mb-3" onclick="quickMatch()">
                            üéØ Quick Match
                        </button>
                        <button class="btn btn-success w-100 mb-3" onclick="createGame()">
                            üÜï Create Game
                        </button>
                        <button class="btn btn-outline-primary w-100" onclick="joinGame()">
                            üîó Join Game
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5>Your Stats</h5>
                        <div class="row text-center">
                            <div class="col-6">
                                <h3 id="games-played">0</h3>
                                <small class="text-muted">Games Played</small>
                            </div>
                            <div class="col-6">
                                <h3 id="games-won">0</h3>
                                <small class="text-muted">Games Won</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <span>Total Earned:</span>
                                <strong id="total-earned">0 birr</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Win Rate:</span>
                                <strong id="win-rate">0%</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="header">
                <h1>üéÆ Chess Game</h1>
                <div id="game-status" style="padding: 8px 15px; border-radius: 20px; background: #fff3cd; color: #856404; display: inline-block;">Waiting</div>
            </div>
            <div class="content">
                <div id="game-info"></div>
                <div id="board-container" style="display: none;">
                    <div class="chess-board" id="chess-board"></div>
                    <div id="turn-indicator" class="alert alert-info text-center mt-3">Loading...</div>
                    <div class="text-center mt-3">
                        <button class="btn btn-danger me-2" onclick="resignGame()">Resign</button>
                        <button class="btn btn-warning" onclick="offerDraw()">Draw</button>
                    </div>
                    <button class="btn btn-outline-secondary w-100 mt-3" onclick="backToDashboard()">‚Üê Back</button>
                </div>
                <div id="waiting-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <h4>Waiting for opponent...</h4>
                        <p>Game ID:</p>
                        <div class="alert alert-secondary text-center">
                            <h3 id="game-id-display">ABCD-1234</h3>
                            <button class="btn btn-sm btn-primary" onclick="copyGameId()">Copy ID</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentGame = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('start');
            
            if (!userId) {
                showError("Please use /start in Telegram bot");
                return;
            }
            
            await checkUser(userId);
        });
        
        async function checkUser(userId) {
            try {
                const response = await fetch(`/api/user/${userId}`);
                if (response.ok) {
                    currentUser = await response.json();
                    showDashboard();
                } else {
                    showRegistration(userId);
                }
            } catch (error) {
                showError("Connection error");
            }
        }
        
        function showRegistration(userId) {
            showScreen('welcome-screen');
            document.getElementById('btn-register').dataset.userId = userId;
        }
        
        async function registerUser() {
            const btn = document.getElementById('btn-register');
            const userId = btn.dataset.userId;
            
            if (!userId) return;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Registering...';
            
            try {
                const response = await fetch('/api/user/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        username: `user_${userId}`,
                        firstName: 'Player'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser = result.user;
                    showToast("üéâ Welcome! You got 10 birr bonus!");
                    setTimeout(() => showDashboard(), 2000);
                } else {
                    showError("Registration failed");
                    btn.disabled = false;
                    btn.innerHTML = 'üéÆ Register & Get 10 birr';
                }
            } catch (error) {
                showError("Connection error");
                btn.disabled = false;
                btn.innerHTML = 'üéÆ Register & Get 10 birr';
            }
        }
        
        function showDashboard() {
            showScreen('dashboard-screen');
            document.getElementById('greeting').textContent = `Welcome, ${currentUser.first_name || currentUser.username}!`;
            document.getElementById('balance').textContent = `${currentUser.balance} birr`;
            document.getElementById('games-played').textContent = currentUser.games_played;
            document.getElementById('games-won').textContent = currentUser.games_won;
            document.getElementById('total-earned').textContent = `${currentUser.total_earned} birr`;
            const winRate = currentUser.games_played > 0 ? Math.round((currentUser.games_won / currentUser.games_played) * 100) : 0;
            document.getElementById('win-rate').textContent = `${winRate}%`;
        }
        
        async function quickMatch() {
            if (!currentUser) return;
            showLoading("Finding opponent...");
            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerId: currentUser.id })
                });
                const result = await response.json();
                if (result.success) {
                    currentGame = result.game;
                    showGameScreen();
                }
            } catch (error) {
                showError("Error");
            }
        }
        
        async function createGame() {
            if (!currentUser) return;
            showLoading("Creating game...");
            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerId: currentUser.id })
                });
                const result = await response.json();
                if (result.success) {
                    currentGame = result.game;
                    showGameScreen();
                }
            } catch (error) {
                showError("Error");
            }
        }
        
        function joinGame() {
            const gameId = prompt("Enter Game ID:");
            if (gameId) joinGameById(gameId);
        }
        
        async function joinGameById(gameId) {
            if (!currentUser) return;
            showLoading("Joining...");
            try {
                const response = await fetch(`/api/game/${gameId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerId: currentUser.id })
                });
                const result = await response.json();
                if (result.success) {
                    currentGame = result.game;
                    showGameScreen();
                } else {
                    showError(result.error || "Cannot join");
                }
            } catch (error) {
                showError("Error");
            }
        }
        
        function showGameScreen() {
            showScreen('game-screen');
            if (currentGame) {
                document.getElementById('game-id-display').textContent = currentGame.id.substring(0, 8);
                updateGameStatus();
                loadGameInfo();
                if (currentGame.status === 'active') {
                    startGame();
                } else {
                    pollGameStatus();
                }
            }
        }
        
        function startGame() {
            document.getElementById('waiting-container').style.display = 'none';
            document.getElementById('board-container').style.display = 'block';
            // Simple board for now - add chess.js later
            document.getElementById('chess-board').innerHTML = '<div class="alert alert-info">Chess board will be here</div>';
            updateGameUI();
            startGamePolling();
        }
        
        function updateGameUI() {
            if (!currentGame) return;
            const isMyTurn = currentGame.current_player === currentUser.id;
            document.getElementById('turn-indicator').textContent = isMyTurn ? 'üéÆ Your Turn!' : '‚è≥ Opponent\'s Turn';
            document.getElementById('turn-indicator').className = isMyTurn ? 'alert alert-success text-center mt-3' : 'alert alert-warning text-center mt-3';
        }
        
        function pollGameStatus() {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/game/${currentGame.id}`);
                    if (response.ok) {
                        const game = await response.json();
                        if (game.status === 'active') {
                            clearInterval(pollInterval);
                            currentGame = game;
                            startGame();
                        }
                    }
                } catch (error) {}
            }, 3000);
        }
        
        function startGamePolling() {
            if (window.gamePollInterval) clearInterval(window.gamePollInterval);
            window.gamePollInterval = setInterval(async () => {
                if (!currentGame || currentGame.status === 'finished') {
                    clearInterval(window.gamePollInterval);
                    return;
                }
                try {
                    const response = await fetch(`/api/game/${currentGame.id}`);
                    if (response.ok) {
                        const updatedGame = await response.json();
                        if (updatedGame.last_move_at !== currentGame.last_move_at) {
                            currentGame = updatedGame;
                            updateGameUI();
                            if (currentGame.status === 'finished') {
                                clearInterval(window.gamePollInterval);
                                gameFinished();
                            }
                        }
                    }
                } catch (error) {}
            }, 2000);
        }
        
        function gameFinished() {
            if (currentGame.winner === currentUser.id) {
                showToast(`üéâ You won! +10 birr`);
                checkUser(currentUser.id);
            }
            setTimeout(() => backToDashboard(), 3000);
        }
        
        function backToDashboard() {
            showDashboard();
            if (currentUser) checkUser(currentUser.id);
        }
        
        function loadGameInfo() {
            const isPlayer1 = currentGame.player1 === currentUser.id;
            document.getElementById('game-info').innerHTML = `
                <div style="display: flex; justify-content: space-between; background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <div><strong>${isPlayer1 ? 'You (White)' : 'Player 1'}</strong></div>
                    <div>VS</div>
                    <div><strong>${!isPlayer1 && currentGame.player2 ? 'You (Black)' : 'Player 2'}</strong></div>
                </div>
            `;
        }
        
        function updateGameStatus() {
            if (!currentGame) return;
            const status = currentGame.status === 'waiting' ? 'Waiting' : currentGame.status === 'active' ? 'Active' : 'Finished';
            const color = currentGame.status === 'waiting' ? '#fff3cd' : currentGame.status === 'active' ? '#d1ecf1' : '#d4edda';
            const textColor = currentGame.status === 'waiting' ? '#856404' : currentGame.status === 'active' ? '#0c5460' : '#155724';
            const badge = document.getElementById('game-status');
            badge.textContent = status;
            badge.style.background = color;
            badge.style.color = textColor;
        }
        
        function copyGameId() {
            if (currentGame) {
                navigator.clipboard.writeText(currentGame.id);
                showToast('Game ID copied!');
            }
        }
        
        function resignGame() {
            if (confirm('Resign?')) {
                showToast('Game resigned');
                setTimeout(() => backToDashboard(), 1000);
            }
        }
        
        function offerDraw() {
            showToast('Draw offer sent');
        }
        
        // Helper functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function showLoading(message) {
            document.querySelector('#loading-screen .loading h4').textContent = message;
            showScreen('loading-screen');
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function showError(message) {
            alert(message);
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.7/dist/chess.min.js"></script>
</body>
</html>
